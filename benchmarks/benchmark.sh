#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
FRAMEWORKS=("styled-static" "emotion" "tailwind" "restyle" "panda-css")
RUNS=5
RESULTS_FILE="$SCRIPT_DIR/results.md"
TMP_DIR="$SCRIPT_DIR/.bench-tmp"
mkdir -p "$TMP_DIR"

# Portable millisecond timestamp (works on macOS and Linux)
now_ms() {
  python3 -c 'import time; print(int(time.time() * 1000))'
}

for fw in "${FRAMEWORKS[@]}"; do
  echo "=== Benchmarking: $fw ==="
  FW_DIR="$SCRIPT_DIR/$fw"
  cd "$FW_DIR"

  # Install dependencies
  bun install --frozen-lockfile 2>/dev/null || bun install

  # Build time: run RUNS times, collect all, take median
  > "$TMP_DIR/${fw}_times.txt"
  for i in $(seq 1 $RUNS); do
    rm -rf dist
    start_ms=$(now_ms)
    bun run build >/dev/null 2>&1
    end_ms=$(now_ms)
    elapsed=$((end_ms - start_ms))
    echo "$elapsed" >> "$TMP_DIR/${fw}_times.txt"
    echo "  Run $i: ${elapsed}ms"
  done

  # Sort and get median
  median=$(sort -n "$TMP_DIR/${fw}_times.txt" | sed -n '3p')
  echo "$median" > "$TMP_DIR/${fw}_build.txt"

  # File sizes (last build is still in dist/)
  find dist -name "*.js" -exec cat {} + 2>/dev/null | wc -c | tr -d ' ' > "$TMP_DIR/${fw}_js_raw.txt"
  find dist -name "*.css" -exec cat {} + 2>/dev/null | wc -c | tr -d ' ' > "$TMP_DIR/${fw}_css_raw.txt"
  find dist -name "*.html" -exec cat {} + 2>/dev/null | wc -c | tr -d ' ' > "$TMP_DIR/${fw}_html_raw.txt"

  # Brotli compressed sizes
  find dist -name "*.js" -exec cat {} + 2>/dev/null | brotli -c 2>/dev/null | wc -c | tr -d ' ' > "$TMP_DIR/${fw}_js_brotli.txt"
  find dist -name "*.css" -exec cat {} + 2>/dev/null | brotli -c 2>/dev/null | wc -c | tr -d ' ' > "$TMP_DIR/${fw}_css_brotli.txt"

  build_time=$(cat "$TMP_DIR/${fw}_build.txt")
  js_raw=$(cat "$TMP_DIR/${fw}_js_raw.txt")
  css_raw=$(cat "$TMP_DIR/${fw}_css_raw.txt")
  echo "  Median build: ${build_time}ms | JS: ${js_raw}B | CSS: ${css_raw}B"
done

# Read baseline (styled-static) values for delta calculations
BASE_BUILD=$(cat "$TMP_DIR/styled-static_build.txt")
BASE_JS_RAW=$(cat "$TMP_DIR/styled-static_js_raw.txt")
BASE_JS_BROTLI=$(cat "$TMP_DIR/styled-static_js_brotli.txt")
BASE_CSS_RAW=$(cat "$TMP_DIR/styled-static_css_raw.txt")
BASE_CSS_BROTLI=$(cat "$TMP_DIR/styled-static_css_brotli.txt")
BASE_HTML_RAW=$(cat "$TMP_DIR/styled-static_html_raw.txt")
BASE_TOTAL_RAW=$((BASE_JS_RAW + BASE_CSS_RAW))
BASE_TOTAL_BROTLI=$((BASE_JS_BROTLI + BASE_CSS_BROTLI))

# Generate results markdown
cat > "$RESULTS_FILE" << 'HEADER'
# CSS Framework Benchmark Results

> Auto-generated by `benchmark.sh`
> Values in parentheses show the delta vs styled-static (baseline).

HEADER

# Helper to format bytes as KB
fmt() { echo "scale=1; $1 / 1024" | bc; }

# Helper to compute delta string: delta <value> <baseline>
# For baseline row, returns empty string. Otherwise returns " (+X.XX%)" or " (-X.XX%)" or " (=)"
delta() {
  local val=$1
  local base=$2
  if [ "$val" -eq "$base" ]; then
    echo ""
    return
  fi
  # Use python3 for float math (bc on macOS can be quirky with signed results)
  python3 -c "
v, b = $val, $base
if b == 0:
    if v == 0:
        print('')
    else:
        print(' (+∞)')
else:
    d = (v - b) / b * 100
    sign = '+' if d > 0 else ''
    print(f' ({sign}{d:.1f}%)')
"
}

echo "| Framework | Build (ms) | JS raw (KB) | JS brotli (KB) | CSS raw (KB) | CSS brotli (KB) | Total raw (KB) | Total brotli (KB) | HTML (KB) |" >> "$RESULTS_FILE"
echo "|---|---|---|---|---|---|---|---|---|" >> "$RESULTS_FILE"

for fw in "${FRAMEWORKS[@]}"; do
  build_time=$(cat "$TMP_DIR/${fw}_build.txt")
  js_raw=$(cat "$TMP_DIR/${fw}_js_raw.txt")
  js_brotli=$(cat "$TMP_DIR/${fw}_js_brotli.txt")
  css_raw=$(cat "$TMP_DIR/${fw}_css_raw.txt")
  css_brotli=$(cat "$TMP_DIR/${fw}_css_brotli.txt")
  html_raw=$(cat "$TMP_DIR/${fw}_html_raw.txt")
  total_raw=$((js_raw + css_raw))
  total_brotli=$((js_brotli + css_brotli))

  if [ "$fw" = "styled-static" ]; then
    # Baseline row — no deltas
    echo "| **$fw** | **$build_time** | **$(fmt $js_raw)** | **$(fmt $js_brotli)** | **$(fmt $css_raw)** | **$(fmt $css_brotli)** | **$(fmt $total_raw)** | **$(fmt $total_brotli)** | **$(fmt $html_raw)** |" >> "$RESULTS_FILE"
  else
    d_build=$(delta $build_time $BASE_BUILD)
    d_js_raw=$(delta $js_raw $BASE_JS_RAW)
    d_js_brotli=$(delta $js_brotli $BASE_JS_BROTLI)
    d_css_raw=$(delta $css_raw $BASE_CSS_RAW)
    d_css_brotli=$(delta $css_brotli $BASE_CSS_BROTLI)
    d_total_raw=$(delta $total_raw $BASE_TOTAL_RAW)
    d_total_brotli=$(delta $total_brotli $BASE_TOTAL_BROTLI)
    d_html=$(delta $html_raw $BASE_HTML_RAW)
    echo "| $fw | ${build_time}${d_build} | $(fmt $js_raw)${d_js_raw} | $(fmt $js_brotli)${d_js_brotli} | $(fmt $css_raw)${d_css_raw} | $(fmt $css_brotli)${d_css_brotli} | $(fmt $total_raw)${d_total_raw} | $(fmt $total_brotli)${d_total_brotli} | $(fmt $html_raw)${d_html} |" >> "$RESULTS_FILE"
  fi
done

# Cleanup
rm -rf "$TMP_DIR"

echo ""
echo "Results written to $RESULTS_FILE"
cat "$RESULTS_FILE"
